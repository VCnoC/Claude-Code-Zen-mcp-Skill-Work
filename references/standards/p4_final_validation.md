# P4 最终质量验证标准（P4 Final Validation - Regression Gate）

> **文档性质**：从 CLAUDE.md 中抽取的复杂操作规范，因验证步骤多且强制执行而独立成文。
> **原文档位置**：CLAUDE.md → 阶段四（P4）→ 回归闸门
> **版本号**：v1.0.0
> **最后更新**：2025-01-14
> **依赖**：references/standards/cli_env_g10.md ≥ v1.0.0（第 2 轮 CLI 深度分析需要使用 G10 标准启动 codex CLI）

---

## 何时进入（触发条件）

当进入 **P4｜错误处理** 阶段并完成修复代码后，**强制进入回归闸门**进行质量验证。

**关键前提**：
- 已完成 P4 修复代码的编写
- 修复代码已应用到代码库
- 即将结束 P4 阶段前（质量闸门）

**绝对禁止**：
- ❌ 跳过回归闸门直接结束 P4 流程
- ❌ 仅执行单轮验证（必须双轮）
- ❌ 修复代码但不更新文档（强制联动）

---

## 核心原则

**P4 修复完成后，必须通过强制质量验证流程才能结束任务。**

---

## 强制验证流程（不可跳过）

### 1. codex 双轮验证（强制）

#### 第 1 轮：工作流验证
- **工具**：`mcp__zen__codereview`
- **检查维度**：
  - 质量：代码规范、复杂度、可维护性
  - 安全：安全漏洞、敏感信息泄露
  - 性能：性能瓶颈、资源消耗
  - 架构：架构一致性、设计模式
  - 文档：代码注释、文档完整性
- **验证内容**：
  - 修复代码是否引入新问题
  - 测试覆盖率是否达标（参见 coverage_target）
  - 代码质量是否符合标准

#### 第 2 轮：CLI 深度分析
- **工具**：`mcp__zen__clink` 调用 codex CLI
- **调用方式**：遵循 G10 环境自适应 CLI 调用标准（见 `references/standards/cli_env_g10.md`）
- **检查内容**：
  - 深度代码逻辑审查
  - 边界条件和异常处理验证
  - 与现有代码库的一致性检查

#### 完成条件
- ✅ 两轮验证均无 Critical/High 级别问题
- ✅ Medium/Low 问题已记录（自动化模式下已自动修复，参见 G11）

---

### 2. 文档联动验证（强制）

#### PROJECTWIKI.md 更新验证
- ✅ 检查"设计决策 & 技术债务"章节是否包含缺陷复盘
- ✅ 复盘内容必须包含：
  - 根因分析（Why - 为什么会出现问题）
  - 修复方案（What - 采用了什么方案）
  - 影响范围（Scope - 影响了哪些模块）
  - 预防措施（Prevention - 如何避免再次出现）
- ✅ 相关 Mermaid 图是否已更新（如有架构或流程变更）
- ✅ 依赖图谱、模块文档、API 手册是否同步更新

#### CHANGELOG.md 更新验证
- ✅ 必须在 `[Unreleased]` 或对应版本中记录修复变更
- ✅ 遵循 Keep a Changelog 格式（Fixed 分区）
- ✅ 包含修复摘要和提交 SHA 引用

#### 双向链接验证
- ✅ PROJECTWIKI.md 中的复盘条目引用 CHANGELOG.md
- ✅ CHANGELOG.md 中的修复记录引用 PROJECTWIKI.md 对应章节

---

### 3. 回归测试验证

- ✅ 重跑触发错误的原始场景（必须通过）
- ✅ 执行关键路径回归测试（覆盖受影响模块）
- ✅ 性能回归检查（确认未引入性能问题）

---

## 验证失败处理策略

### codex 发现 Critical/High 问题
- **处理方式**：返回 P4 重新修复（不得结束流程）
- **执行步骤**：
  1. 更新修复方案
  2. 重新执行修复
  3. 再次进入回归闸门验证

### 文档未更新或不合规
- **处理方式**：强制补充文档更新
- **执行步骤**：
  1. 使用 simple-gemini 生成/更新文档
  2. 验证双向链接有效性
  3. 重新进入文档联动验证

### 回归测试失败
- **若为修复代码引入的新问题**：留在 P4 重新修复
- **若为原有代码的独立问题**：返回 P1 重新分析

---

## 自动化模式下的验证（automation_mode=true）

### 自动触发
- P4 修复代码提交后，**自动进入回归闸门**
- 无需等待用户确认

### 自动修复（条件性）
- **codex 发现的 Medium/Low 问题**：自动修复（参见 G11）
- **Critical/High 问题**：停止并生成报告，询问用户

### 文档自动更新
- **检测到文档缺失**：自动调用 simple-gemini 补充
- **格式不合规**：自动修正

### 透明性记录
- 所有验证结果和自动修复决策记录到 auto_log.md
- 提供完整的验证报告和问题修复清单

---

## 标准流程图（必须经过回归闸门）

```
P4 修复完成
  ↓
【回归闸门】
  ├─ codex 双轮验证
  ├─ 文档联动验证
  └─ 回归测试验证
  ↓
┌──── 验证通过 ────┐
│                 │
↓                 ↓
问题彻底解决    流程结束
```

---

## 转换规则

- **验证通过 + 问题彻底解决** → 流程结束（正常完成）
- **验证失败（代码问题）** → 返回 P4 重新修复（重新进入回归闸门）
- **验证失败（原有独立问题）** → 返回 P1 重新分析
- **问题仍未解决（复杂问题）** → 留在 P4 重复修复步骤

---

## 完成条件（Quality Gate）

**所有条件必须同时满足，才能结束 P4 阶段：**

1. **代码质量**：
   - ✅ codex 双轮验证通过（第 1 轮 + 第 2 轮）
   - ✅ 无 Critical/High 级别问题
   - ✅ Medium/Low 问题已修复或已记录

2. **文档完整性**：
   - ✅ PROJECTWIKI.md 包含缺陷复盘（根因、修复、影响、预防）
   - ✅ CHANGELOG.md 记录修复变更（Fixed 分区）
   - ✅ 双向链接有效

3. **测试验证**：
   - ✅ 原始错误场景测试通过
   - ✅ 关键路径回归测试通过
   - ✅ 性能回归检查通过（无性能退化）

---

## CRITICAL - 绝对禁止

- ❌ **绝对禁止**跳过回归闸门直接结束流程
- ❌ **绝对禁止**仅执行单轮验证（必须双轮）
- ❌ **绝对禁止**修复代码但不更新文档（强制联动）
- ❌ **绝对禁止**在未能稳定重现问题的情况下贸然修改代码
- ❌ **绝对禁止**以权宜的临时补丁替代针对根因的正确修复
- ❌ **绝对禁止**忽视可能引发的连锁影响或知识库文档的同步更新

---

**变更历史**：
- 2025-01-14：从 CLAUDE.md P4 section 抽取，增加"何时进入"和"完成条件"上下文
