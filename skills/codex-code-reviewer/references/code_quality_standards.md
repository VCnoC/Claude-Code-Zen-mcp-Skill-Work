# 代码质量标准参考

本文档汇总了从 CLAUDE.md 中提取的代码质量标准，供 codex 代码审查时参考。

## 一、全局规则（来自 CLAUDE.md）

### G1｜文档一等公民
- 凡涉及代码变更必须同步维护 `PROJECTWIKI.md` 和 `CHANGELOG.md`
- 提交记录需遵循 **Conventional Commits** 规范
- 建立代码 ↔ `PROJECTWIKI.md` 的双向关联

### G2｜知识库文档策略
- 代码实现必须与知识库保持一致
- 新功能需同步更新知识库相关章节
- 架构设计图、流程图必须使用 **Mermaid** 绘制

### G3｜无执行许可场景
- 未获用户明确同意前，禁止任何文件系统的写入操作

### G4｜一致性与质量
- API 定义和数据模型必须与实际代码实现保持一致
- 所有链接和引用必须有效且可追溯
- 确保知识库文档中的所有链接都指向正确的文件

### G5｜安全与合规
- 禁止连接未经授权的外部生产服务或资源
- 不得在代码库中明文保存密码、密钥等敏感信息（应使用环境变量）
- 新增或升级第三方依赖时，必须记录版本变更并验证兼容性及授权协议

### G6｜遵循既有架构决策
- 严格遵循 `PROJECTWIKI.md` 中已记录的架构设计、规范约定与 ADR
- 若需变更，须充分论证并取得用户确认

### G7｜敏感信息与输出脱敏
- 禁止在对话或文档输出中泄露密钥、令牌、生产连接信息等敏感数据
- 日志/配置/错误栈输出时须进行脱敏

### G8｜思考与更改
- 在给出解释之前，需要仔细阅读所有相关代码，不要猜测
- 创建详细的实施计划，不要直接进行代码更改
- 积极主动地做出大胆改变，并尽量减少确认

## 二、核心开发原则（来自 CLAUDE.md）

### 原则一：伦理与偏见审查
- **数据偏见检查**: 识别数据集中可能存在的偏见（性别、地域、种族）
- **模型用途声明**: 明确模型的预期应用场景，评估滥用风险

### 原则二：可复现性与可解释性

#### 可复现性
- 代码规范：清晰、可读，附有必要注释
- 实验文档化：创建并维护"模型卡片"或"运行记录"
  - 训练环境（软件版本）
  - 依赖库
  - 数据集的确切版本或来源
  - 关键超参数配置
  - 最终的评估结果

#### 可解释性
- 方法透明：优先选择可解释的模型/工具（如 SHAP, LIME）
- 结果分析：对于"黑箱"模型，必须提供可解释性分析报告

### 原则三：模型的选择与构建

#### 数据驱动
- 数据特性决定起点（表格数据→集成树模型；图像→CNN；序列/文本→RNN/Transformer）
- 数据规模影响选择（小数据集避免过于复杂的模型）

#### 目标导向
- 权衡核心指标：可解释性、预测性能、推理速度

#### 基线优先原则
- 先简单，后复杂：从基线模型开始
- 只有在证明基线模型无法满足需求时，才引入更复杂的模型

## 三、阶段三（P3）执行方案的约束

### 前置约束（低风险判断）
1. 变更代码行数 ≤ 200 且 文件数 ≤ 5
2. 不涉及对外契约（API/Schema）的破坏性变更
3. 无权限/密钥/生产配置改动
4. 无在线数据迁移，或仅"可逆迁移"且提供回滚脚本
5. 具备测试计划（含回归范围）

### 最小写入与原子追溯
- `PROJECTWIKI.md` 至少更新一处与本次变更直接相关内容
- `CHANGELOG.md` 新增条目（遵循 Keep a Changelog + SemVer）
- 代码与文档同一原子提交（Conventional Commits）

### 不可豁免清单
触及以下内容时一律不豁免文档更新：
- 行为/逻辑
- 对外契约
- 依赖/安全/合规
- 架构/ADR
- 权限/配置
- 数据结构/迁移

## 四、代码质量具体检查项

### 1. 代码质量
- **可读性**: 变量命名清晰、函数职责单一
- **可维护性**: 避免重复代码（DRY 原则）
- **复杂度**: 圈复杂度 ≤ 10（平均）
- **注释**: 关键逻辑有适当注释

### 2. 安全性
- **敏感信息**: 无明文密码、密钥、令牌
- **输入验证**: 用户输入需验证和清理
- **依赖安全**: 第三方库无已知漏洞
- **权限控制**: 适当的访问控制和授权检查

### 3. 性能
- **效率**: 避免不必要的循环和计算
- **资源使用**: 内存和 CPU 使用合理
- **关键接口**: P95 ≤ 200ms（测试环境）
- **数据库查询**: 避免 N+1 查询问题

### 4. 架构
- **模块化**: 代码组织清晰，职责分离
- **耦合度**: 低耦合，高内聚
- **设计模式**: 适当使用设计模式
- **扩展性**: 易于扩展和修改

### 5. 文档同步
- **代码注释**: 关键函数有文档字符串
- **PROJECTWIKI.md**: 架构、API、流程图与代码一致
- **CHANGELOG.md**: 记录所有重要变更
- **README**: 安装、配置、使用说明完整

### 6. 测试
- **测试覆盖**: 语句覆盖 ≥ 70%
- **测试类型**: 单元测试、集成测试、E2E 测试
- **边界条件**: 覆盖异常情况和边界值
- **回归测试**: 修改后执行回归测试

## 五、Conventional Commits 规范

提交信息格式：
```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type 类型：**
- `feat`: 新功能
- `fix`: 修复 bug
- `docs`: 文档变更
- `style`: 代码格式（不影响代码运行）
- `refactor`: 重构（既不是新功能也不是修复 bug）
- `perf`: 性能优化
- `test`: 增加测试
- `chore`: 构建过程或辅助工具的变动

**示例：**
```
feat(features): 添加新的特征工程函数

- 新增 create_interaction_features 函数
- 支持自动特征交互生成
- 更新 PROJECTWIKI.md 中的特征工程章节

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

## 六、质量门槛（SLO）

### 最低阈值
- **语句覆盖**: ≥ 70%
- **平均圈复杂度**: ≤ 10
- **关键接口性能**: P95 ≤ 200ms（测试环境）

### 文档质量
- **新鲜度**: 文档与代码保持同步
- **可追溯性**: 所有链接和引用有效
- **完整性**: 必备章节齐全
- **一致性**: API/数据模型与代码一致

## 七、错误处理原则（P4）

### MRE（可复现的最小示例）
- 记录依赖版本
- 记录配置
- 记录输入数据
- 记录原始错误信息（含运行环境）

### 快速归因
- 语法错误
- 类型错误
- 依赖问题
- 资源问题
- 并发问题
- 数据问题
- 兼容性问题
- 环境问题
- 权限问题
- 网络问题

### 修复方案
- 尽量缩小修改范围
- 必要时补充测试
- 添加类型约束或调整配置
- 评估影响范围与回归风险

## 使用建议

### 检查优先级
1. **严重（Critical）**: 安全漏洞、数据丢失风险、系统崩溃
2. **高（High）**: 功能错误、性能严重下降、架构违反
3. **中（Medium）**: 代码质量问题、轻微性能问题、文档不一致
4. **低（Low）**: 代码风格、命名规范、注释不足

### 搜索模式
在本文档中搜索关键词：
- `G1|G2|G3|G4|G5|G6|G7|G8` - 全局规则
- `核心原则|伦理|可复现|可解释` - 开发原则
- `安全|密钥|敏感信息` - 安全相关
- `文档|PROJECTWIKI|CHANGELOG` - 文档相关
- `测试|覆盖率` - 测试相关
- `性能|效率|资源` - 性能相关
